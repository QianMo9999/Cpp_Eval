# 批量评价模式说明

## 🚀 速度优化

系统现在使用**批量评价模式**，大幅提升评价速度！

### 性能对比

| 模式 | API调用次数 | 预估时间（82学生×8题） |
|------|------------|----------------------|
| **旧模式**（逐题评价） | 656次 | ~33分钟 |
| **新模式**（批量评价）⭐ | 82次 | ~4分钟 |

**速度提升：8倍！**

---

## 工作原理

### 旧模式（已废弃）
```
学生A-题目1 → API调用1 → 评价
学生A-题目2 → API调用2 → 评价
...
学生A-题目8 → API调用8 → 评价
等所有学生评价完 → 统一生成所有PDF
```
**问题**：
- 每道题单独调用API，非常慢
- 需要等所有学生评价完才能看到PDF

### 新模式（当前）⭐
```
学生A-所有8道题 → API调用1 → 一次性获得所有评价 → 立即生成学生A的PDF
学生B-所有8道题 → API调用1 → 一次性获得所有评价 → 立即生成学生B的PDF
...
```
**优势**：
- ✅ API调用减少8倍
- ✅ 评价更连贯（大模型能看到学生整体表现）
- ✅ 成本更低
- ✅ **实时生成PDF**：评价完一个学生立即生成PDF，无需等待

---

## 使用示例

```bash
# 运行批量评价
python3 src/main.py data/第02周上机作业.zip --week 02
```

**输出示例**：
```
[步骤 3/4] 开始批量评价 (共78个学生)...
💡 提示：现在使用批量评价模式，每个学生的所有题目一次性评价，速度更快！
💡 评价完一个学生立即生成PDF，无需等待所有人评价完成
------------------------------------------------------------

[1/78] 评价学生: 52********00 泮妍竹 (8道题)
   正在评价 8 道题...
✓ 评价完成 (平均分: 85.3/100，8/8题)
   正在生成PDF报告...
✓ PDF报告已生成

[2/78] 评价学生: 52********01 苏文卿 (8道题)
   正在评价 8 道题...
✓ 评价完成 (平均分: 90.5/100，8/8题)
   正在生成PDF报告...
✓ PDF报告已生成
...
```

---

## 评价格式

系统会自动解析批量评价结果，支持以下格式：

### 格式1：使用 ===  分隔
```markdown
### 题目1: 第1关-求三位数
**分数**: 85/100

**优点**:
- 代码逻辑清晰

**需要改进**:
- 缺少注释

===

### 题目2: 第2关-数字加密
**分数**: 90/100
...
```

### 格式2：使用 --- 分隔
```markdown
### 题目1: 第1关-求三位数
**分数**: 85/100
...

---

### 题目2: 第2关-数字加密
**分数**: 90/100
...
```

系统会自动识别并解析！

---

## 优点

1. **速度快** - API调用次数减少8倍（或题目数倍）
2. **成本低** - 减少API调用费用
3. **评价质量更好** - 大模型能看到学生的整体表现，给出更全面的评价
4. **灵活** - 自动适应不同题目数（5题、8题、10题都可以）
5. **实时反馈** - 评价完一个学生立即生成PDF，不用等待所有人完成

---

## 注意事项

1. **题目数量灵活**
   - 系统自动适应不同周次的题目数
   - 不限定必须是8道题
   - 支持1-20道题（甚至更多）

2. **API限制**
   - 每次请求的token数会增加（包含所有题目代码）
   - 对于DeepSeek，单次请求上限32K tokens，一般8-10道题没问题
   - 如果题目很多或代码很长，可能需要调整

3. **错误处理**
   - 如果批量评价失败，该学生的所有题目都会标记为失败
   - 建议先用1-2个学生测试

---

## 自定义提示词

可以在 `config/prompts.py` 中自定义批量评价提示词：

```python
WEEK_BATCH_PROMPTS = {
    "02": """你是一位经验丰富的C++编程教师...

    评价要求：
    1. 逐题评价
    2. 每题给出0-100分
    3. 使用===分隔
    """,

    "03": """第03周的评价标准...""",
}
```

---

## 故障排除

**Q: 评价结果不完整怎么办？**

A: 检查以下几点：
1. 大模型是否正确输出了所有题目的评价
2. 分隔符是否使用了 `===` 或 `---`
3. 查看JSON结果文件确认原始评价内容

**Q: 某个学生评价失败？**

A: 可能原因：
1. 代码太长，超过API限制
2. 网络问题
3. API配额不足

查看详细错误信息，单独重新评价该学生。

---

**更新时间**: 2024-10-29
**版本**: v1.3.0 - 批量评价优化版
